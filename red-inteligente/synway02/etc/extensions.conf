; extensions.conf - the Asterisk dial plan
;
; Static extension configuration file, used by
; the pbx_config module. This is where you configure all your
; inbound and outbound calls in Asterisk.
;
; This configuration file is reloaded
; - With the "dialplan reload" command in the CLI
; - With the "reload" command (that reloads everything) in the CLI

;
; The "General" category is for certain variables.
;
[general]
;
; If static is set to no, or omitted, then the pbx_config will rewrite
; this file when extensions are modified.  Remember that all comments
; made in the file will be lost when that happens.
;
; XXX Not yet implemented XXX
;
static=yes
;
; if static=yes and writeprotect=no, you can save dialplan by
; CLI command "dialplan save" too
;
writeprotect=no
;
; If autofallthrough is set, then if an extension runs out of
; things to do, it will terminate the call with BUSY, CONGESTION
; or HANGUP depending on Asterisk's best guess. This is the default.
;
; If autofallthrough is not set, then if an extension runs out of
; things to do, Asterisk will wait for a new extension to be dialed
; (this is the original behavior of Asterisk 1.0 and earlier).
;
;autofallthrough=no
;
;
;
; If extenpatternmatchnew is set (true, yes, etc), then a new algorithm that uses
; a Trie to find the best matching pattern is used. In dialplans
; with more than about 20-40 extensions in a single context, this
; new algorithm can provide a noticeable speedup.
; With 50 extensions, the speedup is 1.32x
; with 88 extensions, the speedup is 2.23x
; with 138 extensions, the speedup is 3.44x
; with 238 extensions, the speedup is 5.8x
; with 438 extensions, the speedup is 10.4x
; With 1000 extensions, the speedup is ~25x
; with 10,000 extensions, the speedup is 374x
; Basically, the new algorithm provides a flat response
; time, no matter the number of extensions.
;
; By default, the old pattern matcher is used.
;
; ****This is a new feature! *********************
; The new pattern matcher is for the brave, the bold, and
; the desperate. If you have large dialplans (more than about 50 extensions
; in a context), and/or high call volume, you might consider setting
; this value to "yes" !!
; Please, if you try this out, and are forced to return to the
; old pattern matcher, please report your reasons in a bug report
; on https://issues.asterisk.org. We have made good progress in providing
; something compatible with the old matcher; help us finish the job!
;
; This value can be switched at runtime using the cli command "dialplan set extenpatternmatchnew true"
; or "dialplan set extenpatternmatchnew false", so you can experiment to your hearts content.
;
;extenpatternmatchnew=no
;
; If clearglobalvars is set, global variables will be cleared
; and reparsed on a dialplan reload, or Asterisk reload.
;
; If clearglobalvars is not set, then global variables will persist
; through reloads, and even if deleted from the extensions.conf or
; one of its included files, will remain set to the previous value.
;
; NOTE: A complication sets in, if you put your global variables into
; the AEL file, instead of the extensions.conf file. With clearglobalvars
; set, a "reload" will often leave the globals vars cleared, because it
; is not unusual to have extensions.conf (which will have no globals)
; load after the extensions.ael file (where the global vars are stored).
; So, with "reload" in this particular situation, first the AEL file will
; clear and then set all the global vars, then, later, when the extensions.conf
; file is loaded, the global vars are all cleared, and then not set, because
; they are not stored in the extensions.conf file.
;
clearglobalvars=no
;
; User context is where entries from users.conf are registered.  The
; default value is 'default'
;
;userscontext=default
;
; You can include other config files, use the #include command
; (without the ';'). Note that this is different from the "include" command
; that includes contexts within other contexts. The #include command works
; in all asterisk configuration files.
;#include "filename.conf"
;#include <filename.conf>
;#include filename.conf
;
; You can execute a program or script that produces config files, and they
; will be inserted where you insert the #exec command. The #exec command
; works on all asterisk configuration files.  However, you will need to
; activate them within asterisk.conf with the "execincludes" option.  They
; are otherwise considered a security risk.
;#exec /opt/bin/build-extra-contexts.sh
;#exec /opt/bin/build-extra-contexts.sh --foo="bar"
;#exec </opt/bin/build-extra-contexts.sh --foo="bar">
;#exec "/opt/bin/build-extra-contexts.sh --foo=\"bar\""
;

; The "Globals" category contains global variables that can be referenced
; in the dialplan with the GLOBAL dialplan function:
; ${GLOBAL(VARIABLE)}
; ${${GLOBAL(VARIABLE)}} or ${text${GLOBAL(VARIABLE)}} or any hybrid
; Unix/Linux environmental variables can be reached with the ENV dialplan
; function: ${ENV(VARIABLE)}
;
[globals]
CONSOLE=Console/dsp				; Console interface for demo
;CONSOLE=DAHDI/1
;CONSOLE=Phone/phone0
IAXINFO=guest					; IAXtel username/password
;IAXINFO=myuser:mypass
TRUNK=DAHDI/G2					; Trunk interface
;
; Note the 'G2' in the TRUNK variable above. It specifies which group (defined
; in chan_dahdi.conf) to dial, i.e. group 2, and how to choose a channel to use
; in the specified group. The four possible options are:
;
; g: select the lowest-numbered non-busy DAHDI channel
;    (aka. ascending sequential hunt group).
; G: select the highest-numbered non-busy DAHDI channel
;    (aka. descending sequential hunt group).
; r: use a round-robin search, starting at the next highest channel than last
;    time (aka. ascending rotary hunt group).
; R: use a round-robin search, starting at the next lowest channel than last
;    time (aka. descending rotary hunt group).
;
TRUNKMSD=1					; MSD digits to strip (usually 1 or 0)
;TRUNK=IAX2/user:pass@provider

;FREENUMDOMAIN=mydomain.com                     ; domain to send on outbound
                                                ; freenum calls (uses outbound-freenum
                                                ; context)

;
; WARNING WARNING WARNING WARNING
; If you load any other extension configuration engine, such as pbx_ael.so,
; your global variables may be overridden by that file.  Please take care to
; use only one location to set global variables, and you will likely save
; yourself a ton of grief.
; WARNING WARNING WARNING WARNING
;
; Any category other than "General" and "Globals" represent
; extension contexts, which are collections of extensions.
;
; Extension names may be numbers, letters, or combinations
; thereof. If an extension name is prefixed by a '_'
; character, it is interpreted as a pattern rather than a
; literal.  In patterns, some characters have special meanings:
;
;   X - any digit from 0-9
;   Z - any digit from 1-9
;   N - any digit from 2-9
;   [1235-9] - any digit in the brackets (in this example, 1,2,3,5,6,7,8,9)
;   . - wildcard, matches anything remaining (e.g. _9011. matches
;	anything starting with 9011 excluding 9011 itself)
;   ! - wildcard, causes the matching process to complete as soon as
;       it can unambiguously determine that no other matches are possible
;
; For example, the extension _NXXXXXX would match normal 7 digit dialings,
; while _1NXXNXXXXXX would represent an area code plus phone number
; preceded by a one.
;
; Each step of an extension is ordered by priority, which must always start
; with 1 to be considered a valid extension.  The priority "next" or "n" means
; the previous priority plus one, regardless of whether the previous priority
; was associated with the current extension or not.  The priority "same" or "s"
; means the same as the previously specified priority, again regardless of
; whether the previous entry was for the same extension.  Priorities may be
; immediately followed by a plus sign and another integer to add that amount
; (most useful with 's' or 'n').  Priorities may then also have an alias, or
; label, in parentheses after their name which can be used in goto situations.
;
; Contexts contain several lines, one for each step of each extension.  One may
; include another context in the current one as well, optionally with a date
; and time.  Included contexts are included in the order they are listed.
; Switches may also be included within a context.  The order of matching within
; a context is always exact extensions, pattern match extensions, includes, and
; switches.  Includes are always processed depth-first.  So for example, if you
; would like a switch "A" to match before context "B", simply put switch "A" in
; an included context "C", where "C" is included in your original context
; before "B".
;
;[context]
;exten => someexten,{priority|label{+|-}offset}[(alias)],application(arg1,arg2,...)
;
; Timing list for includes is
;
;   <time range>,<days of week>,<days of month>,<months>[,<timezone>]
;
; Note that ranges may be specified to wrap around the ends.  Also, minutes are
; fine-grained only down to the closest even minute.
;
;include => daytime,9:00-17:00,mon-fri,*,*
;include => weekend,*,sat-sun,*,*
;include => weeknights,17:02-8:58,mon-fri,*,*
;
; ignorepat can be used to instruct drivers to not cancel dialtone upon receipt
; of a particular pattern.  The most commonly used example is of course '9'
; like this:
;
;ignorepat => 9
;
; so that dialtone remains even after dialing a 9.  Please note that ignorepat
; only works with channels which receive dialtone from the PBX, such as DAHDI,
; Phone, and VPB.  Other channels, such as SIP and MGCP, which generate their
; own dialtone and converse with the PBX only after a number is complete, are
; generally unaffected by ignorepat (unless DISA or another method is used to
; generate a dialtone after answering the channel).
;

;
; Sample entries for extensions.conf
;
;
[dundi-e164-canonical]
;include => stdexten
;
; List canonical entries here
;
;exten => 12564286000,1,Gosub(6000,stdexten(IAX2/foo))
;exten => 12564286000,n,Goto(default,s,1)	; exited Voicemail
;exten => _125642860XX,1,Dial(IAX2/otherbox/${EXTEN:7})

[dundi-e164-customers]
;
; If you are an ITSP or Reseller, list your customers here.
;
;exten => _12564286000,1,Dial(SIP/customer1)
;exten => _12564286001,1,Dial(IAX2/customer2)

[dundi-e164-via-pstn]
;
; If you are freely delivering calls to the PSTN, list them here
;
;exten => _1256428XXXX,1,Dial(DAHDI/G2/${EXTEN:7}) ; Expose all of 256-428
;exten => _1256325XXXX,1,Dial(DAHDI/G2/${EXTEN:7}) ; Ditto for 256-325

[dundi-e164-local]
;
; Context to put your dundi IAX2 or SIP user in for
; full access
;
include => dundi-e164-canonical
include => dundi-e164-customers
include => dundi-e164-via-pstn

[dundi-e164-switch]
;
; Just a wrapper for the switch
;
switch => DUNDi/e164

[dundi-e164-lookup]
;
; Locally to lookup, try looking for a local E.164 solution
; then try DUNDi if we don't have one.
;
include => dundi-e164-local
include => dundi-e164-switch
;
; DUNDi can also be implemented as a Macro instead of using
; the Local channel driver.
;
[macro-dundi-e164]
;
; ARG1 is the extension to Dial
;
; Extension "s" is not a wildcard extension that matches "anything".
; In macros, it is the start extension. In most other cases,
; you have to goto "s" to execute that extension.
;
; Note: In old versions of Asterisk the PBX in some cases defaulted to
; extension "s" when a given extension was wrong (like in AMI originate).
; This is no longer the case.
;
; For wildcard matches, see above - all pattern matches start with
; an underscore.
exten => s,1,Goto(${ARG1},1)
include => dundi-e164-lookup

;
; Here are the entries you need to participate in the IAXTEL
; call routing system.  Most IAXTEL numbers begin with 1-700, but
; there are exceptions.  For more information, and to sign
; up, please go to www.gnophone.com or www.iaxtel.com
;
[iaxtel700]
exten => _91700XXXXXXX,1,Dial(IAX2/${GLOBAL(IAXINFO)}@iaxtel.com/${EXTEN:1}@iaxtel)

;
; The SWITCH statement permits a server to share the dialplan with
; another server. Use with care: Reciprocal switch statements are not
; allowed (e.g. both A -> B and B -> A), and the switched server needs
; to be on-line or else dialing can be severly delayed.
;
[iaxprovider]
;switch => IAX2/user:[key]@myserver/mycontext

[trunkint]
;
; International long distance through trunk
;
exten => _9011.,1,Macro(dundi-e164,${EXTEN:4})
exten => _9011.,n,Dial(${GLOBAL(TRUNK)}/${FILTER(0-9,${EXTEN:${GLOBAL(TRUNKMSD)}})})

[trunkld]
;
; Long distance context accessed through trunk
;
exten => _91NXXNXXXXXX,1,Macro(dundi-e164,${EXTEN:1})
exten => _91NXXNXXXXXX,n,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})

[trunklocal]
;
; Local seven-digit dialing accessed through trunk interface
;
exten => _9NXXXXXX,1,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})

[trunktollfree]
;
; Long distance context accessed through trunk interface
;
exten => _91800NXXXXXX,1,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})
exten => _91888NXXXXXX,1,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})
exten => _91877NXXXXXX,1,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})
exten => _91866NXXXXXX,1,Dial(${GLOBAL(TRUNK)}/${EXTEN:${GLOBAL(TRUNKMSD)}})

[international]
;
; Master context for international long distance
;
ignorepat => 9
include => longdistance
include => trunkint

[longdistance]
;
; Master context for long distance
;
ignorepat => 9
include => local
include => trunkld

[local]
;
; Master context for local, toll-free, and iaxtel calls only
;
ignorepat => 9
include => default
include => trunklocal
include => iaxtel700
include => trunktollfree
include => iaxprovider

;Include parkedcalls (or the context you define in features conf)
;to enable call parking.
include => parkedcalls
;
; You can use an alternative switch type as well, to resolve
; extensions that are not known here, for example with remote
; IAX switching you transparently get access to the remote
; Asterisk PBX
;
; switch => IAX2/user:password@bigserver/local
;
; An "lswitch" is like a switch but is literal, in that
; variable substitution is not performed at load time
; but is passed to the switch directly (presumably to
; be substituted in the switch routine itself)
;
; lswitch => Loopback/12${EXTEN}@othercontext
;
; An "eswitch" is like a switch but the evaluation of
; variable substitution is performed at runtime before
; being passed to the switch routine.
;
; eswitch => IAX2/context@${CURSERVER}

; The following two contexts are a template to enable the ability to dial
; ISN numbers. For more information about what an ISN number is, please see
; http://www.freenum.org.
;
; This is the dialing hook.  use:
; include => outbound-freenum

[outbound-freenum]
; We'll add more digits as needed. The purpose is to dial things
; like extension numbers at domains (ITAD number) so we're matching
; on lengths of 1 through 6 prior to the separator (the asterisk [*])
;
exten => _X*X!,1,Goto(outbound-freenum2,${EXTEN},1)
exten => _XX*X!,1,Goto(outbound-freenum2,${EXTEN},1)
exten => _XXX*X!,1,Goto(outbound-freenum2,${EXTEN},1)
exten => _XXXX*X!,1,Goto(outbound-freenum2,${EXTEN},1)
exten => _XXXXX*X!,1,Goto(outbound-freenum2,${EXTEN},1)
exten => _XXXXXX*X!,1,Goto(outbound-freenum2,${EXTEN},1)

[macro-trunkdial]
;
; Standard trunk dial macro (hangs up on a dialstatus that should
; terminate call)
;   ${ARG1} - What to dial
;
exten => s,1,Dial(${ARG1})
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-NOANSWER,1,Hangup
exten => s-BUSY,1,Hangup
exten => _s-.,1,NoOp

[stdexten]
;
; Standard extension subroutine:
;   ${EXTEN} - Extension
;   ${ARG1} - Device(s) to ring
;   ${ARG2} - Optional context in Voicemail
;
; Note that the current version will drop through to the next priority in the
; case of their pressing '#'.  This gives more flexibility in what do to next:
; you can prompt for a new extension, or drop the call, or send them to a
; general delivery mailbox, or...
;
; The use of the LOCAL() function is purely for convenience.  Any variable
; initially declared as LOCAL() will disappear when the innermost Gosub context
; in which it was declared returns.  Note also that you can declare a LOCAL()
; variable on top of an existing variable, and its value will revert to its
; previous value (before being declared as LOCAL()) upon Return.
;
exten => _X.,50000(stdexten),NoOp(Start stdexten)
exten => _X.,n,Set(LOCAL(ext)=${EXTEN})
exten => _X.,n,Set(LOCAL(dev)=${ARG1})
exten => _X.,n,Set(LOCAL(cntx)=${ARG2})
exten => _X.,n,Set(LOCAL(mbx)=${ext}${IF($[!${ISNULL(${cntx})}]?@${cntx})})
exten => _X.,n,Dial(${dev},20)				; Ring the interface, 20 seconds maximum
exten => _X.,n,Goto(stdexten-${DIALSTATUS},1)		; Jump based on status (NOANSWER,BUSY,CHANUNAVAIL,CONGESTION,ANSWER)

exten => stdexten-NOANSWER,1,Voicemail(${mbx},u)	; If unavailable, send to voicemail w/ unavail announce
exten => stdexten-NOANSWER,n,Return()			; If they press #, return to start

exten => stdexten-BUSY,1,Voicemail(${mbx},b)		; If busy, send to voicemail w/ busy announce
exten => stdexten-BUSY,n,Return()			; If they press #, return to start

exten => _stde[x]te[n]-.,1,Goto(stdexten-NOANSWER,1)	; Treat anything else as no answer

exten => a,1,VoicemailMain(${mbx})			; If they press *, send the user into VoicemailMain
exten => a,n,Return()

[stdPrivacyexten]
;
; Standard extension subroutine:
;   ${ARG1} - Extension
;   ${ARG2} - Device(s) to ring
;   ${ARG3} - Optional DONTCALL context name to jump to (assumes the s,1 extension-priority)
;   ${ARG4} - Optional TORTURE context name to jump to (assumes the s,1 extension-priority)`
;   ${ARG5} - Context in voicemail (if empty, then "default")
;
; See above note in stdexten about priority handling on exit.
;
exten => _X.,60000(stdPrivacyexten),NoOp(Start stdPrivacyexten)
exten => _X.,n,Set(LOCAL(ext)=${ARG1})
exten => _X.,n,Set(LOCAL(dev)=${ARG2})
exten => _X.,n,Set(LOCAL(dontcntx)=${ARG3})
exten => _X.,n,Set(LOCAL(tortcntx)=${ARG4})
exten => _X.,n,Set(LOCAL(cntx)=${ARG5})

exten => _X.,n,Set(LOCAL(mbx)="${ext}"$["${cntx}" ? "@${cntx}" :: ""])
exten => _X.,n,Dial(${dev},20,p)			; Ring the interface, 20 seconds maximum, call screening
						; option (or use P for databased call _X.creening)
exten => _X.,n,Goto(stdexten-${DIALSTATUS},1)		; Jump based on status (NOANSWER,BUSY,CHANUNAVAIL,CONGESTION,ANSWER)

exten => stdexten-NOANSWER,1,Voicemail(${mbx},u)	; If unavailable, send to voicemail w/ unavail announce
exten => stdexten-NOANSWER,n,NoOp(Finish stdPrivacyexten NOANSWER)
exten => stdexten-NOANSWER,n,Return()			; If they press #, return to start

exten => stdexten-BUSY,1,Voicemail(${mbx},b)		; If busy, send to voicemail w/ busy announce
exten => stdexten-BUSY,n,NoOp(Finish stdPrivacyexten BUSY)
exten => stdexten-BUSY,n,Return()			; If they press #, return to start

exten => stdexten-DONTCALL,1,Goto(${dontcntx},s,1)	; Callee chose to send this call to a polite "Don't call again" script.

exten => stdexten-TORTURE,1,Goto(${tortcntx},s,1)	; Callee chose to send this call to a telemarketer torture script.

exten => _stde[x]te[n]-.,1,Goto(stdexten-NOANSWER,1)	; Treat anything else as no answer

exten => a,1,VoicemailMain(${mbx})		; If they press *, send the user into VoicemailMain
exten => a,n,Return

[macro-page];
;
; Paging macro:
;
;       Check to see if SIP device is in use and DO NOT PAGE if they are
;
;   ${ARG1} - Device to page

exten => s,1,ChanIsAvail(${ARG1},s)			; s is for ANY call
exten => s,n,GoToIf($[${AVAILSTATUS} = "1"]?autoanswer:fail)
exten => s,n(autoanswer),Set(_ALERT_INFO="RA")			; This is for the PolyComs
exten => s,n,SIPAddHeader(Call-Info: Answer-After=0)	; This is for the Grandstream, Snoms, and Others
exten => s,n,NoOp()					; Add others here and Post on the Wiki!!!!
exten => s,n,Dial(${ARG1})
exten => s,n(fail),Hangup


[demo]
include => stdexten
;
; We start with what to do when a call first comes in.
;
exten => s,1,Wait(1)			; Wait a second, just for fun
exten => s,n,Answer			; Answer the line
exten => s,n,Set(TIMEOUT(digit)=5)	; Set Digit Timeout to 5 seconds
exten => s,n,Set(TIMEOUT(response)=10)	; Set Response Timeout to 10 seconds
exten => s,n(restart),BackGround(demo-congrats)	; Play a congratulatory message
exten => s,n(instruct),BackGround(demo-instruct)	; Play some instructions
exten => s,n,WaitExten			; Wait for an extension to be dialed.

exten => 2,1,BackGround(demo-moreinfo)	; Give some more information.
exten => 2,n,Goto(s,instruct)

exten => 3,1,Set(LANGUAGE()=fr)		; Set language to french
exten => 3,n,Goto(s,restart)		; Start with the congratulations

exten => 1000,1,Goto(default,s,1)
;
; We also create an example user, 1234, who is on the console and has
; voicemail, etc.
;
exten => 1234,1,Playback(transfer,skip)		; "Please hold while..."
					; (but skip if channel is not up)
exten => 1234,n,Gosub(${EXTEN},stdexten(${GLOBAL(CONSOLE)}))
exten => 1234,n,Goto(default,s,1)		; exited Voicemail

exten => 1235,1,Voicemail(1234,u)		; Right to voicemail

exten => 1236,1,Dial(Console/dsp)		; Ring forever
exten => 1236,n,Voicemail(1234,b)		; Unless busy

;
; # for when they're done with the demo
;
exten => #,1,Playback(demo-thanks)	; "Thanks for trying the demo"
exten => #,n,Hangup			; Hang them up.

;
; A timeout and "invalid extension rule"
;
exten => t,1,Goto(#,1)			; If they take too long, give up
exten => i,1,Playback(invalid)		; "That's not valid, try again"

;
; Create an extension, 500, for dialing the
; Asterisk demo.
;
exten => 500,1,Playback(demo-abouttotry); Let them know what's going on
exten => 500,n,Dial(IAX2/guest@pbx.digium.com/s@default)	; Call the Asterisk demo
exten => 500,n,Playback(demo-nogo)	; Couldn't connect to the demo site
exten => 500,n,Goto(s,6)		; Return to the start over message.

;
; Create an extension, 600, for evaluating echo latency.
;
exten => 600,1,Playback(demo-echotest)	; Let them know what's going on
exten => 600,n,Echo			; Do the echo test
exten => 600,n,Playback(demo-echodone)	; Let them know it's over
exten => 600,n,Goto(s,6)		; Start over

;
;	You can use the Macro Page to intercom a individual user
exten => 76245,1,Macro(page,SIP/Grandstream1)
; or if your peernames are the same as extensions
exten => _7XXX,1,Macro(page,SIP/${EXTEN})
;
;
; System Wide Page at extension 7999
;
exten => 7999,1,Set(TIMEOUT(absolute)=60)
exten => 7999,2,Page(Local/Grandstream1@page&Local/Xlite1@page&Local/1234@page/n,d)

; Give voicemail at extension 8500
;
exten => 8500,1,VoicemailMain
exten => 8500,n,Goto(s,6)
;
; Here's what a phone entry would look like (IXJ for example)
;
;exten => 1265,1,Dial(Phone/phone0,15)
;exten => 1265,n,Goto(s,5)

;
;	The page context calls up the page macro that sets variables needed for auto-answer
;	It is in is own context to make calling it from the Page() application as simple as
;	Local/{peername}@page
;
[page]
exten => _X.,1,Macro(page,SIP/${EXTEN})

;[mainmenu]
;
; Example "main menu" context with submenu
;
;exten => s,1,Answer
;exten => s,n,Background(thanks)		; "Thanks for calling press 1 for sales, 2 for support, ..."
;exten => s,n,WaitExten
;exten => 1,1,Goto(submenu,s,1)
;exten => 2,1,Hangup
;include => default
;
;[submenu]
;exten => s,1,Ringing					; Make them comfortable with 2 seconds of ringback
;exten => s,n,Wait,2
;exten => s,n,Background(submenuopts)	; "Thanks for calling the sales department.  Press 1 for steve, 2 for..."
;exten => s,n,WaitExten
;exten => 1,1,Goto(default,steve,1)
;exten => 2,1,Goto(default,mark,2)

[default]
;
; By default we include the demo.  In a production system, you
; probably don't want to have the demo there.
;
include => demo

;
; An extension like the one below can be used for FWD, Nikotel, sipgate etc.
; Note that you must have a [sipprovider] section in sip.conf
;
;exten => _41X.,1,Dial(SIP/${FILTER(0-9,${EXTEN:2})}@sipprovider,,r)

; Real extensions would go here. Generally you want real extensions to be
; 4 or 5 digits long (although there is no such requirement) and start with a
; single digit that is fairly large (like 6 or 7) so that you have plenty of
; room to overlap extensions and menu options without conflict.  You can alias
; them with names, too, and use global variables

;exten => 6245,hint,SIP/Grandstream1&SIP/Xlite1(Joe Schmoe) ; Channel hints for presence
;exten => 6245,1,Dial(SIP/Grandstream1,20,rt)	; permit transfer
;exten => 6245,n(dial),Dial(${HINT},20,rtT)	; Use hint as listed
;exten => 6245,n,Voicemail(6245,u)		; Voicemail (unavailable)
;exten => 6245,s+1,Hangup			; s+1, same as n
;exten => 6245,dial+101,Voicemail(6245,b)	; Voicemail (busy)
;exten => 6361,1,Dial(IAX2/JaneDoe,,rm)		; ring without time limit
;exten => 6389,1,Dial(MGCP/aaln/1@192.168.0.14)
;exten => 6390,1,Dial(JINGLE/caller/callee) ; Dial via jingle using labels
;exten => 6391,1,Dial(JINGLE/asterisk@digium.com/mogorman@astjab.org) ;Dial via jingle using asterisk as the transport and calling mogorman.
;exten => 6394,1,Dial(Local/6275/n)		; this will dial ${MARK}

;exten => 6275,1,Gosub(${EXTEN},stdexten(${MARK}))
						; assuming ${MARK} is something like DAHDI/2
;exten => 6275,n,Goto(default,s,1)		; exited Voicemail
;exten => mark,1,Goto(6275,1)			; alias mark to 6275
;exten => 6536,1,Gosub(${EXTEN},stdexten(${WIL}))
						; Ditto for wil
;exten => 6536,n,Goto(default,s,1)		; exited Voicemail
;exten => wil,1,Goto(6236,1)

;If you want to subscribe to the status of a parking space, this is
;how you do it. Subscribe to extension 6600 in sip, and you will see
;the status of the first parking lot with this extensions' help
;exten => 6600,hint,park:701@parkedcalls
;exten => 6600,1,noop
;
; Some other handy things are an extension for checking voicemail via
; voicemailmain
;
;exten => 8500,1,VoicemailMain
;exten => 8500,n,Hangup
;
; Or a conference room (you'll need to edit meetme.conf to enable this room)
;
;exten => 8600,1,Meetme(1234)
;
; Or playing an announcement to the called party, as soon it answers
;
;exten = 8700,1,Dial(${MARK},30,A(/path/to/my/announcemsg))
;

; example of a compartmentalized company called "acme"
;
; this is the context that your incoming IAX/SIP trunk dumps you in...
;[acme-incoming]
;exten => s,1,Wait(1)
;exten => s,n,Answer()
;exten => s,n(menu),Playback(acme/vm-brief-menu)
;exten => s,n(exten),Background(vm-enter-num-to-call)
;exten => s,n,WaitExten(5)
;exten => s,n(goodbye),Playback(vm-goodbye)
;exten => s,n(end),Hangup()
;
;include  => acme-extens
;
;exten => i,1,Playback(vm-invalid)
;exten => i,n,Goto(s,exten)			; optionally, transfer to operator
;
;exten => t,1,Goto(s,goodbye)
;
; this is the context our internal SIP hardphones use (see sip.conf)
;
;[acme-internal]
;exten => s,1,Answer()
;exten => s,n(exten),Background(vm-enter-num-to-call)
;exten => s,n,WaitExten(5)
;exten => s,n(goodbye),Playback(vm-goodbye)
;exten => s,n(end),Hangup()
;
;include => trunkint
;include => trunkld
;include => trunklocal
;
;include => acme-extens
;
; you can test what your system sounds like to outside callers by dialing this
;exten => 777,1,DISA(no-password,acme-incoming)
;
; grouping of acme's extensions... never used directly, always included.
;
;[acme-extens]
;include => stdexten
;exten => 111,1,Gosub(111,stdexten(SIP/pete_1,acme))
;exten => 111,n,Goto(s,exten)
;
;exten => 112,1,Gosub(112,stdexten(SIP/nancy_1,acme))
;exten => 112,n,Goto(s,end)
;
; end of acme example

;
; Time context: you can patch this in via the following.
;
; [acme-internal]
; ...
; exten => 777,1,Gosub(time)
; exten => 777,n,Hangup()
;
; ...
; include => time
;
; Note: if you're geographically spread out, you can have SIP extensions
; specify their own local timezone in sip.conf as:
;
; [boi]
; type=friend
; context=acme-internal
; callerid="Boise Ofc. <2083451111>"
; ...
; ; use system-wide default timezone of MST7MDT
;
; [lws]
; type=friend
; context=acme-internal
; callerid="Lewiston Ofc. <2087431111>"
; ...
; setvar=timezone=PST8PDT
;
; "timezone" isn't a 'reserved' name in any way, and other places where
; the timezone is significant (e.g. calls to "SayUnixTime()", etc) will
; require modification as well.  Note that voicemail.conf already has
; a mechanism for timezones.
;

[time]
exten => _X.,30000(time),NoOp(Time: ${EXTEN} ${timezone})
exten => _X.,n,Wait(0.25)
exten => _X.,n,Answer()
; the amount of delay is set for English; you may need to adjust this time
; for other languages if there's no pause before the synchronizing beep.
exten => _X.,n,Set(FUTURETIME=$[${EPOCH} + 12])
exten => _X.,n,SayUnixTime(${FUTURETIME},Zulu,HNS)
exten => _X.,n,SayPhonetic(z)
; use the timezone associated with the extension (sip only), or system-wide
; default if one hasn't been set.
exten => _X.,n,SayUnixTime(${FUTURETIME},${timezone},HNS)
exten => _X.,n,Playback(spy-local)
exten => _X.,n,WaitUntil(${FUTURETIME})
exten => _X.,n,Playback(beep)
exten => _X.,n,Return()

;
; ANI context: use in the same way as "time" above
;

[ani]
exten => _X.,40000(ani),NoOp(ANI: ${EXTEN})
exten => _X.,n,Wait(0.25)
exten => _X.,n,Answer()
exten => _X.,n,Playback(vm-from)
exten => _X.,n,SayDigits(${CALLERID(ani)})
exten => _X.,n,Wait(1.25)
exten => _X.,n,SayDigits(${CALLERID(ani)})	; playback again in case of missed digit
exten => _X.,n,Return()

; For more information on applications, just type "core show applications" at your
; friendly Asterisk CLI prompt.
;
; "core show application <command>" will show details of how you
; use that particular application in this file, the dial plan.
; "core show functions" will list all dialplan functions
; "core show function <COMMAND>" will show you more information about
; one function. Remember that function names are UPPER CASE.

[sipp]
exten => 2000,1,Answer
exten => 2000,2,SetMusicOnHold(default)
exten => 2000,3,WaitMusicOnHold(20)
exten => 2000,4,Hangup

[cfraude]
;;;########### DID: 0053,0093,... / Servicio CONTROL FRAUDE  ###########;;;
;;;NO APLICA ETAPA DE BIENVENIDA
;;;ETAPA VALIDACION: CONTROL FRAUDE
exten => _00.,1,NoOp(${EXTEN})
exten => _00.,n,Set(CDR(dni-cfraude)=${EXTEN})
exten => _00.,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_CFRAUDE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=AM_IO)
exten => _00.,n,Goto(sf-${errorCode},1)
exten => sf-OK,1,Gosub(procesoFraude,s,1)
exten => sf-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado,noanswer)
;exten => sf-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado)
exten => sf-PARAM_MISSING,n,Hangup()
exten => sf-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => sf-NO_TARIFF,n,Hangup()
exten => _sf-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _sf-.,n,Hangup()

;;;ETAPA PROCESO: CONTROL FRAUDE
[procesoFraude]
exten => s,1,NoOp(${CDR(dni-cfraude)})
exten => s,n,AGI(agi://192.168.62.31/proceso,agent=AGENT_CFRAUDE,dni=${CDR(dni-cfraude)})
exten => s,n,Goto(pf-${errorCode},1)
exten => pf-OK,1,NoOp(${errorCode})
;exten => pf-OK,n,Set(cnt_ani=${SHELL(/usr/sbin/asterisk -rx "core show channels verbose" | grep ${CALLERID(num)} | awk '{print $2 "|" $5 "|" $6 "|" $7 "|" $8 "|" $9}' | grep billingFraude | grep Up)})
exten => pf-OK,n,Set(cnt_ani=${SHELL(/usr/sbin/asterisk -rx "core show channels verbose" | grep ${CALLERID(num)} | awk '{print $2 "|" $5 "|" $6 "|" $7 "|" $8 "|" $9}' | grep -i billingFraude | grep -i Dial | wc -l | tr -d "\r\n")})
exten => pf-OK,n,NoOp(procesoFraude - limit_concurrent_calls ${limit_concurrent_calls})
exten => pf-OK,n,GotoIf($[${cnt_ani} < ${limit_concurrent_calls}]?proceso-ok:proceso-nook)
exten => pf-OK,n(proceso-nook),Playback(lo_siento_no_fue_posible_conectar_su_llamada,noanswer)
exten => pf-OK,n,Hangup()
exten => pf-OK,n(proceso-ok),Gosub(billingFraude,s,1)
exten => pf-PARAM_MISSING,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada,noanswer)
exten => pf-PARAM_MISSING,n,Hangup()
exten => pf-NOT_FOUND,1,Playback(serv_no_habilitado_para_este_destino,noanswer)
exten => pf-NOT_FOUND,n,Hangup()
exten => pf-NO_TARIFF,1,Playback(no_esta_permitidoeldestino,noanswer)
exten => pf-NO_TARIFF,n,Hangup()
exten => pf-NO_SALDO_AVAILABLE,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada,noanswer)
exten => pf-NO_SALDO_AVAILABLE,n,Hangup()
exten => h,1,NoOp('FORCED HANGUP en fase de PROCESO')
exten => h,n,Gosub(billing-cfraude-forced,s,1)

;;;ETAPA BILLING: CONTROL FRAUDE
[billingFraude]
exten => s,1,Set(cnt_ani=${SHELL(/usr/sbin/asterisk -rx "core show channels verbose" | grep ${CALLERID(num)} | awk '{print $2 "|" $5 "|" $6 "|" $7 "|" $8 "|" $9}' | grep -i billingFraude | wc -l | tr -d "\r\n")})
;exten => s,n,Set(cnt_out=${SHELL(/usr/sbin/asterisk -rx "core show channels verbose" | grep ${CALLERID(num)} | awk '{print $2 "|" $5 "|" $6 "|" $7 "|" $8 "|" $9}' | grep -i billingFraude)})
;exten => s,n,NoOp(${cnt_out})
exten => s,n,NoOp(billingFraude - limit_concurrent_calls ${limit_concurrent_calls})
exten => s,n,GotoIf($[${cnt_ani} <= ${limit_concurrent_calls}]?b-proceso-ok:b-proceso-nook)
exten => s,n(b-proceso-nook),Playback(lo_siento_no_fue_posible_conectar_su_llamada,noanswer)
exten => s,n,Hangup()
exten => s,n(b-proceso-ok),Set(TIMEOUT(absolute)=$[${samples_disponibles}*${sampDelayInSec}])
;exten => s,1,Set(TIMEOUT(absolute)=$[${samples_disponibles}*${sampDelayInSec}])
exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(CDR(familyName)=CFRD)
exten => s,n,Dial(DAHDI/g2/${CDR(dni-cfraude)},45)
exten => s,n,Goto(bf-${DIALSTATUS},1)
exten => bf-ANSWER,1,NoOp(${DIALSTATUS})
exten => bf-ANSWER,n,Hangup()
exten => bf-NOANSWER,1,Playback(el_num_que_marco_no_contesta,noanswer)
exten => bf-NOANSWER,n,Hangup()
exten => bf-CHANUNAVAIL,1,Playback(no_fue_posible_conectar_su_llamada,noanswer)
exten => bf-CHANUNAVAIL,n,Hangup()
exten => bf-CONGESTION,1,Playback(no_fue_posible_conectar_su_llamada,noanswer)
exten => bf-CONGESTION,n,Hangup()
exten => bf-BUSY,1,Playback(el_num_que_marco_esta_ocupado,noanswer)
exten => bf-BUSY,n,Hangup()
exten => h,1,NoOp(${CDR(duration-callin)})
exten => h,n,AGI(agi://192.168.62.31/billing,agent=AGENT_CFRAUDE,did=${CDR(dni-cfraude)},did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING_CFRAUDE,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

[billing-cfraude-forced]
exten => s,1,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,NoOp(${CDR(duration-callin)})
exten => s,n,Set(CDR(familyName)=CFRD)
exten => s,n,AGI(agi://192.168.62.31/billing,agent=AGENT_CFRAUDE,did=${CDR(dni-cfraude)},did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING_CFRAUDE,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=FORCED,releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

[nsoft]

;;;########### DID: 0800XXXXX ###########;;;
;exten => _080XXXXXX,1,NoOp(${EXTEN})
;exten => _080XXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
;exten => _080XXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portax-${errorCode},1)
;exten => _080XXXXXX,n,NoOp(numero_traducido ${numero_traducido})
;exten => _080XXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
;exten => _080XXXXXX,n,Hangup(31)
;exten => portax-UNMATCHED,1,Hangup(1)

exten => _080XXXXXX,1,NoOp(${EXTEN})
exten => _080XXXXXX,n,GotoIf($[${CALLERID(num)} = 17198928]?portax-central)
exten => _080XXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _080XXXXXX,n,Goto(portax-continue)
exten => _080XXXXXX,n(portax-central),AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)},pre_prod=1)
exten => _080XXXXXX,n(portax-continue),GotoIf($["${errorCode}" != "OK"]?portax-${errorCode},1)
exten => _080XXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _080XXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _080XXXXXX,n,Hangup(31)
exten => portax-UNMATCHED,1,Hangup(1)

;exten => _37XX80XXXXXX,1,NoOp(${EXTEN})
;exten => _37XX80XXXXXX,n,AGI(agi://10.16.16.11/portax,did=0${EXTEN:4},cli=${CALLERID(num)},nrn_orig=${EXTEN:2:2})
;exten => _37XX80XXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaex-${errorCode},1)
;exten => _37XX80XXXXXX,n,NoOp(numero_traducido ${numero_traducido})
;exten => _37XX80XXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
;exten => _37XX80XXXXXX,n,Hangup(31)
;exten => portaex-UNMATCHED,1,Hangup(1)

exten => _37XX80XXXXXX,1,NoOp(${EXTEN})
exten => _37XX80XXXXXX,n,GotoIf($[${CALLERID(num)} = 17198928]?portax-central)
exten => _37XX80XXXXXX,n,AGI(agi://10.16.16.11/portax,did=0${EXTEN:4},cli=${CALLERID(num)},nrn_orig=${EXTEN:2:2})
exten => _37XX80XXXXXX,n,Goto(portax-continue)
exten => _37XX80XXXXXX,n(portax-central),AGI(agi://10.16.16.11/portax,did=0${EXTEN:4},cli=${CALLERID(num)},nrn_orig=${EXTEN:2:2},pre_prod=1)
exten => _37XX80XXXXXX,n(portax-continue),GotoIf($["${errorCode}" != "OK"]?portaex-${errorCode},1)
exten => _37XX80XXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _37XX80XXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _37XX80XXXXXX,n,Hangup(31)
exten => portaex-UNMATCHED,1,Hangup(1)

exten => _197710X,1,NoOp(${EXTEN})
exten => _197710X,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _197710X,n,GotoIf($["${errorCode}" != "OK"]?portaflex-${errorCode},1)
exten => _197710X,n,NoOp(numero_traducido ${numero_traducido})
exten => _197710X,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _197710X,n,Hangup(31)
exten => portaflex-UNMATCHED,1,Hangup(1)

;;;########### DID: 1933 MULTICARRIER ###########;;;
exten => _19330NXXXXXXX,1,NoOp(${EXTEN})
exten => _19330NXXXXXXX,n,Playback(1933_americatel)
exten => _19330NXXXXXXX,n,Dial(DAHDI/g1/${EXTEN:4})
exten => _19330NXXXXXXX,n,Hangup()

exten => _193300.,1,NoOp(${EXTEN})
exten => _193300.,n,Playback(1933_americatel)
exten => _193300.,n,Dial(DAHDI/g1/${EXTEN:4})
exten => _193300.,n,Hangup()

;;;########### DID: 1977123 / Servicio PLAN CONTROL ###########;;;
;;;BIENVENIDA: PLAN CONTROL
exten => 1977123,1,Answer
exten => 1977123,n,Playback(bienvenido_al_servicio_americatel)
;;;ETAPA VALIDACION: PLAN CONTROL
;============= Pruebas 1977123 - ANI 14368814 =============;
;exten => 1977123,n,Set(agent=${IF($[${CALLERID(num)} = 14368814]?AGENT\_1977123:AGENT)})
;===>exten => 1977123,n,Set(agent=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?AGENT\_1977123:AGENT)})
;exten => 1977123,n,Set(trunkName=${IF($[${CALLERID(num)} = 14368814]?1977_IO:AM_IO)})
;===>exten => 1977123,n,Set(trunkName=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?1977_IO:AM_IO)})
;===>exten => 1977123,n,NoOp(Marco Risco - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName})
;;exten => 1977123,n,AGI(agi://192.168.62.31/validacion,agent=AGENT,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977124,cli=${CALLERID(num)},trunkName=AM_IO)
;===>exten => 1977123,n,AGI(agi://192.168.62.31/validacion,agent=${agent},switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977124,cli=${CALLERID(num)},trunkName=${trunkName})
;============= Pruebas 1977123 - ANI 14368814 =============;

;===>exten => s,n,Set(proceso=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?proceso\_1977:proceso)})
;===>exten => s,n,NoOp(Marco Risco - proceso: ${proceso} - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName})

;=================== Integracion 1977123 ===================;
exten => 1977123,n,Set(agent=AGENT_1977123)
exten => 1977123,n,Set(proceso=proceso_1977)
exten => 1977123,n,Set(trunkName=1977_IO)
exten => 1977123,n,AGI(agi://192.168.62.31/validacion,agent=${agent},switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977124,cli=${CALLERID(num)},trunkName=${trunkName})
exten => 1977123,n,GotoIf($["${errorCode}" = "OK"]?s-OK,1)
exten => 1977123,n,Set(agent=AGENT)
exten => 1977123,n,Set(proceso=proceso)
exten => 1977123,n,Set(trunkName=AM_IO)
exten => 1977123,n,AGI(agi://192.168.62.31/validacion,agent=${agent},switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977124,cli=${CALLERID(num)},trunkName=${trunkName})
;=================== Integracion 1977123 ===================;

exten => 1977123,n,Goto(s-${errorCode},1)
exten => s-OK,1,Gosub(proceso,s,1)
exten => s-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado)
exten => s-PARAM_MISSING,n,Hangup()
exten => s-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado)
exten => s-NO_TARIFF,n,Hangup()
exten => _s-.,1,Playback(este_num_telf_no_esta_registrado)
exten => _s-.,n,Hangup()

;;;########### DID: 1977125 / Servicio PLAN BONOS   ###########;;;
;;;BIENVENIDA: PLAN BONOS
exten => 1977125,1,Answer
exten => 1977125,n,Playback(bienvenido_al_servicio_americatel)
;;;ETAPA VALIDACION: PLAN BONOS
exten => 1977125,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_BONOS,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977144,cli=${CALLERID(num)},trunkName=AM_IO)
exten => 1977125,n,Goto(sb-${errorCode},1)
exten => sb-OK,1,Gosub(procesoBonos,s,1)
exten => sb-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado)
exten => sb-PARAM_MISSING,n,Hangup()
exten => sb-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado)
exten => sb-NO_TARIFF,n,Hangup()
exten => _sb-.,1,Playback(este_num_telf_no_esta_registrado)
exten => _sb-.,n,Hangup()

;;;########### DID: 1566 / Servicio PREPAGO         ###########;;;
;;;BIENVENIDA: PREPAGO
exten => 1566,1,Answer
exten => 1566,n,NoOp(Channel ${CHANNEL})
exten => 1566,n,Playback(bienvenido_al_servicio_americatel)
;;;ETAPA VALIDACION: PREPAGO
exten => 1566,n,Read(accountPin,ingrese_clave_acceso,,,2,5)
exten => 1566,n,GotoIf($["${accountPin}" = ""]?sp-NO_INGRESO_PIN,1)
exten => 1566,n,AGI(agi://192.168.62.31/validacion,agent=Agent_Prepaid,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},accountPin=${accountPin},trunkName=AM_IO)
exten => 1566,n,Goto(sp-${errorCode},1)
exten => sp-OK,1,Gosub(procesoPrepaid,s,1)
exten => sp-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado)
exten => sp-PARAM_MISSING,n,Hangup()
exten => sp-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado)
exten => sp-NO_TARIFF,n,Hangup()
exten => sp-NO_INGRESO_PIN,1,Playback(hasta_pronto_gracias_por_preferir&americatelperu)
exten => sp-NO_INGRESO_PIN,n,Hangup()
exten => sp-NOT_FOUND,1,Playback(clave_ingresada_es_incorrecta)
exten => sp-NOT_FOUND,n,Hangup()
exten => _sp-.,1,Playback(este_num_telf_no_esta_registrado)
exten => _sp-.,n,Hangup()

;;;########### DID: 1977 FIJO - LIMA / Servicio BLACKLIST         ###########;;;
;;;DESTINO LIMA [2-8]XXXXXX
;;;C3: LDN
exten => _1977[2-8]XXXXXX,1,NoOp(${EXTEN})

;;;###### FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;
;;;exten => _1977[2-8]XXXXXX,n,Set(errorCode=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14368815] | $[${CALLERID(num)} = 44204010] | $[${CALLERID(num)} = 52202020] | $[${CALLERID(num)} = 54447808] | $[${CALLERID(num)} = 54608530] | $[${CALLERID(num)} = 12428257] | $[${CALLERID(num)} = 13709062] | $[${CALLERID(num)} = 14899761] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 44530225] | $[${CALLERID(num)} = 54253269] | $[${CALLERID(num)} = 64202823] | $[${CALLERID(num)} = 84248206] | $[${CALLERID(num)} = 14262057] | $[${CALLERID(num)} = 13460313] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 14522819] | $[${CALLERID(num)} = 12653002] | $[${CALLERID(num)} = 12470879]]?OK:UNMATCHED)})
;;;exten => _1977[2-8]XXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxfijoLimBL-${errorCode},1)
;;;###### FIN FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;

exten => _1977[2-8]XXXXXX,n,Set(DNI=${EXTEN})
exten => _1977[2-8]XXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _1977[2-8]XXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxfijoLimBL-${errorCode},1)
exten => _1977[2-8]XXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _1977[2-8]XXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _1977[2-8]XXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C3,trunkName=AM_IO)
exten => _1977[2-8]XXXXXX,n,Goto(fijoLimBL-${errorCode},1)
exten => fijoLimBL-OK,1,Hangup(21)
exten => fijoLimBL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => fijoLimBL-ZONE_CLI_NOT_FOUND,n,Goto(fijoLimBLani-${errorCode},1)
exten => fijoLimBLani-OK,1,Hangup(31)
exten => fijoLimBLani-BLOCK,1,Hangup(21)
exten => fijoLimBLani-UNMATCHED,1,Hangup(1)
exten => portaxfijoLimBL-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 FIJO - PROV / Servicio BLACKLIST         ###########;;;
;;;DESTINO LIMA [2-8]XXXXX
;;;C3: LDN
exten => _1977[2-8]XXXXX,1,NoOp(${EXTEN})

;;;###### FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;
;;;exten => _1977[2-8]XXXXX,n,Set(errorCode=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14368815] | $[${CALLERID(num)} = 44204010] | $[${CALLERID(num)} = 52202020] | $[${CALLERID(num)} = 54447808] | $[${CALLERID(num)} = 54608530] | $[${CALLERID(num)} = 12428257] | $[${CALLERID(num)} = 13709062] | $[${CALLERID(num)} = 14899761] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 44530225] | $[${CALLERID(num)} = 54253269] | $[${CALLERID(num)} = 64202823] | $[${CALLERID(num)} = 84248206] | $[${CALLERID(num)} = 14262057] | $[${CALLERID(num)} = 13460313] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 14522819] | $[${CALLERID(num)} = 12653002] | $[${CALLERID(num)} = 12470879]]?OK:UNMATCHED)})
;;;exten => _1977[2-8]XXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxfijoProvBL-${errorCode},1)
;;;###### FIN FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;

exten => _1977[2-8]XXXXX,n,Set(DNI=${EXTEN})
exten => _1977[2-8]XXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _1977[2-8]XXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxfijoProvBL-${errorCode},1)
exten => _1977[2-8]XXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _1977[2-8]XXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _1977[2-8]XXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C3,trunkName=AM_IO)
exten => _1977[2-8]XXXXX,n,Goto(fijoProvBL-${errorCode},1)
exten => fijoProvBL-OK,1,Hangup(21)
exten => fijoProvBL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => fijoProvBL-ZONE_CLI_NOT_FOUND,n,Goto(fijoProvBLani-${errorCode},1)
exten => fijoProvBLani-OK,1,Hangup(31)
exten => fijoProvBLani-BLOCK,1,Hangup(21)
exten => fijoProvBLani-UNMATCHED,1,Hangup(1)
exten => portaxfijoProvBL-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 MOVIL / Servicio BLACKLIST         ###########;;;
;;;DESTINO LIMA 9XXXXXXXX
;;;C3: LDN
exten => _19779XXXXXXXX,1,NoOp(${EXTEN})

;;;###### FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;
;;;exten => _19779XXXXXXXX,n,Set(errorCode=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14368815] | $[${CALLERID(num)} = 44204010] | $[${CALLERID(num)} = 52202020] | $[${CALLERID(num)} = 54447808] | $[${CALLERID(num)} = 54608530] | $[${CALLERID(num)} = 12428257] | $[${CALLERID(num)} = 13709062] | $[${CALLERID(num)} = 14899761] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 44530225] | $[${CALLERID(num)} = 54253269] | $[${CALLERID(num)} = 64202823] | $[${CALLERID(num)} = 84248206] | $[${CALLERID(num)} = 14262057] | $[${CALLERID(num)} = 13460313] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 14522819] | $[${CALLERID(num)} = 12653002] | $[${CALLERID(num)} = 12470879]]?OK:UNMATCHED)})
;;;exten => _19779XXXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxmovilBL-${errorCode},1)
;;;###### FIN FILTRO DE VALIDACION (PARA ELIMINAR) ######;;;

exten => _19779XXXXXXXX,n,Set(DNI=${EXTEN})
exten => _19779XXXXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _19779XXXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxmovilBL-${errorCode},1)
exten => _19779XXXXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _19779XXXXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _19779XXXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C3,trunkName=AM_IO)
exten => _19779XXXXXXXX,n,Goto(movilBL-${errorCode},1)
exten => movilBL-OK,1,Hangup(21)
exten => movilBL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => movilBL-ZONE_CLI_NOT_FOUND,n,Goto(movilBLani-${errorCode},1)
exten => movilBLani-OK,1,Hangup(31)
exten => movilBLani-BLOCK,1,Hangup(21)
exten => movilBLani-UNMATCHED,1,Hangup(1)
exten => portaxmovilBL-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 LDN / Servicio BLACKLIST         ###########;;;
;;;DESTINO PROVINCIAS 0[4-8]XXXXXXX
;;;C3: LDN
exten => _19770[4-8]XXXXXXX,1,NoOp(${EXTEN})
exten => _19770[4-8]XXXXXXX,n,Set(DNI=${EXTEN})
exten => _19770[4-8]XXXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _19770[4-8]XXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxldnBL-${errorCode},1)
exten => _19770[4-8]XXXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _19770[4-8]XXXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _19770[4-8]XXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C3,trunkName=AM_IO)
exten => _19770[4-8]XXXXXXX,n,Goto(ldnBL-${errorCode},1)
exten => ldnBL-OK,1,Hangup(21)
exten => ldnBL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => ldnBL-ZONE_CLI_NOT_FOUND,n,Goto(ldnBLani-${errorCode},1)
exten => ldnBLani-OK,1,Hangup(31)
exten => ldnBLani-BLOCK,1,Hangup(21)
exten => ldnBLani-UNMATCHED,1,Hangup(1)
exten => portaxldnBL-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 LDN / Servicio BLACKLIST         ###########;;;
;;;DESTINO LIMA 01XXXXXXX
;;;C3: LDN
exten => _197701XXXXXXX,1,NoOp(${EXTEN})
exten => _197701XXXXXXX,n,Set(DNI=${EXTEN})
exten => _197701XXXXXXX,n,AGI(agi://10.16.16.11/portax,did=${EXTEN},cli=${CALLERID(num)})
exten => _197701XXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?portaxldn1BL-${errorCode},1)
exten => _197701XXXXXXX,n,NoOp(numero_traducido ${numero_traducido})
exten => _197701XXXXXXX,n,Set(_SS7_REDIRECTING_NUMBER=${numero_traducido})
exten => _197701XXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C3,trunkName=AM_IO)
exten => _197701XXXXXXX,n,Goto(ldn1BL-${errorCode},1)
exten => ldn1BL-OK,1,Hangup(21)
exten => ldn1BL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => ldn1BL-ZONE_CLI_NOT_FOUND,n,Goto(ldn1BLani-${errorCode},1)
exten => ldn1BLani-OK,1,Hangup(31)
exten => ldn1BLani-BLOCK,1,Hangup(21)
exten => ldn1BLani-UNMATCHED,1,Hangup(1)
exten => portaxldn1BL-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 LDI / Servicio BLACKLIST         ###########;;;
;;;NUMERO TEST CHILE: 1977005625862600
;;;C4: LDI
exten => _197700.,1,NoOp(${EXTEN})
exten => _197700.,n,Set(DNI=${EXTEN})
exten => _197700.,n,Set(_SS7_REDIRECTING_NUMBER=${EXTEN})
exten => _197700.,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C4,trunkName=AM_IO)
exten => _197700.,n,Goto(ldiBL-${errorCode},1)
exten => ldiBL-OK,1,Hangup(21)
exten => ldiBL-ZONE_CLI_NOT_FOUND,1,AGI(agi://192.168.62.31/validacion_ani,did=${DNI},cli=${CALLERID(num)})
exten => ldiBL-ZONE_CLI_NOT_FOUND,n,Goto(ldiBLani-${errorCode},1)
exten => ldiBLani-OK,1,Hangup(31)
exten => ldiBLani-BLOCK,1,Hangup(21)
exten => ldiBLani-UNMATCHED,1,Hangup(1)

;;;########### DID: 1977 LDI / Servicio BLACKLIST         ###########;;;
;;;NUMERO TEST CHILE: 1977 1 005625862600
;;;C4: LDI
exten => _1977100.,1,NoOp(${EXTEN})
exten => _1977100.,n,Set(_SS7_REDIRECTING_NUMBER=${EXTEN})
exten => _1977100.,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C4,trunkName=AM_IO)
;exten => _1977100.,n,Set(errorCode=ZONE_CLI_NOT_FOUND)
exten => _1977100.,n,Goto(ldi1BL-${errorCode},1)
exten => ldi1BL-OK,1,Hangup(21)
exten => ldi1BL-ZONE_CLI_NOT_FOUND,1,Hangup(31)

;;;########### DID: 1977 LDI / Servicio BLACKLIST         ###########;;;
;;;NUMERO TEST CHILE: 1977 2 005625862600
;;;C4: LDI
exten => _1977200.,1,NoOp(${EXTEN})
exten => _1977200.,n,Set(_SS7_REDIRECTING_NUMBER=${EXTEN})
exten => _1977200.,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ACL,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},custom=C4,trunkName=AM_IO)
;exten => _1977200.,n,Set(errorCode=ZONE_CLI_NOT_FOUND)
exten => _1977200.,n,Goto(ldi2BL-${errorCode},1)
exten => ldi2BL-OK,1,Hangup(21)
exten => ldi2BL-ZONE_CLI_NOT_FOUND,1,Hangup(31)

;;;############# DID: 1577 / Servicio INTEROPERABILIDAD ################;;;

;;;1577 LOCAL
;;;BIENVENIDA: 1577 INTEROP
;exten => _1577[2-8].,1,Answer
exten => _1577[2-8].,1,Playback(1577_americatel,noanswer)
;;;Analisis de Coberturas - AGENT_ZONE
exten => _1577[2-8].,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ZONE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=ZONE_IO)
exten => _1577[2-8].,n,GotoIf($["${errorCode}" != "OK"]?sil-${errorCode},1)
exten => _1577[2-8].,n,Set(DID_EXTEN=1577125${EXTEN:4})
exten => _1577[2-8].,n,NoOp(CLI_NUMBER ${CALLERID(num)})
exten => _1577[2-8].,n,Goto(${DID_EXTEN},1)
;;;ETAPA VALIDACION: 1577 INTEROP
exten => _1577[2-8].,n(PLANAC),NoOp(exten ${EXTEN})
;;;Cambios en la facturacion ENTEL CHILE
exten => _1577[2-8].,n,NoOp(cli ${CALLERID(num)})
exten => _1577[2-8].,n,Set(area_code=${CALLERID(num):0:1})
exten => _1577[2-8].,n,Set(area_code=${IF($["${area_code}" = "1"]?$[${area_code}]:$[${CALLERID(num):0:2}])})
exten => _1577[2-8].,n,Set(cdr-dni-interop=1577${area_code}${EXTEN:4})
exten => _1577[2-8].,n,Set(CDR(dni-interop)=${EXTEN})
exten => _1577[2-8].,n,AGI(agi://192.168.62.31/validacion,agent=Agent_1577,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=AM_IO)
exten => _1577[2-8].,n,Goto(sil-${errorCode},1)
exten => sil-OK,1,Gosub(procesoInterop,s,1)
;;;PROCESO DE ERRORES
;SI EL ANI TIENE UN PLAN 1577 PERO EL DESTINO MARCADO NO TIENE TARIFA ASIGNADA
;SE RECIBE CODIGO DE ERROR: ZONE_NOT_VALID
exten => sil-ZONE_NOT_VALID,1,Playback(no_esta_permitidoeldestino,noanswer)
exten => sil-ZONE_NOT_VALID,n,Hangup()
;SE RECIBE CODIGO DE ERROR: NO_TARIFF
exten => sil-NO_TARIFF,1,Playback(no_fue_posible_conectar_su_llamada,noanswer)
exten => sil-NO_TARIFF,n,Hangup()
;SI EL ANI NO TIENE UN PLAN 1577 SE RECIBE CODIGO DE ERROR: PARAM_MISSING
exten => sil-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado,noanswer)
;exten => sil-PARAM_MISSING,1,Dial(DAHDI/g2/${CDR(dni-interop)},45)
exten => sil-PARAM_MISSING,n,Hangup()
;EN CASO SE RECIBA OTRO CODIGO DE ERROR
exten => _sil-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _sil-.,n,Hangup()

;;;1577 MOVIL
;;;BIENVENIDA: 1577 INTEROP
;exten => _15779XXXXXXXX,1,Answer
exten => _15779XXXXXXXX,1,Playback(1577_americatel,noanswer)
;;;Analisis de Coberturas - AGENT_ZONE
exten => _15779XXXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ZONE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=ZONE_IO)
exten => _15779XXXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?sim-${errorCode},1)
exten => _15779XXXXXXXX,n,Set(DID_EXTEN=1577125${EXTEN:4})
exten => _15779XXXXXXXX,n,NoOp(DID_EXTEN ${DID_EXTEN})
exten => _15779XXXXXXXX,n,NoOp(CLI_NUMBER ${CALLERID(num)})
exten => _15779XXXXXXXX,n,Goto(${DID_EXTEN},1)
;;;ETAPA VALIDACION: 1577 INTEROP
exten => _15779XXXXXXXX,n(PLANAC),NoOp(exten ${EXTEN})
exten => _15779XXXXXXXX,n,Set(CDR(dni-interop)=${EXTEN})
exten => _15779XXXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=Agent_1577,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=AM_IO)
exten => _15779XXXXXXXX,n,Goto(sim-${errorCode},1)
exten => sim-OK,1,Gosub(procesoInterop,s,1)
;;;PROCESO DE ERRORES
;SI EL ANI TIENE UN PLAN 1577 PERO EL DESTINO MARCADO NO TIENE TARIFA ASIGNADA
;SE RECIBE CODIGO DE ERROR: ZONE_NOT_VALID
exten => sim-ZONE_NOT_VALID,1,Playback(no_esta_permitidoeldestino,noanswer)
exten => sim-ZONE_NOT_VALID,n,Hangup()
;SE RECIBE CODIGO DE ERROR: NO_TARIFF
exten => sim-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => sim-NO_TARIFF,n,Hangup()
;SI EL ANI NO TIENE UN PLAN 1577 SE RECIBE CODIGO DE ERROR: PARAM_MISSING
exten => sim-PARAM_MISSING,1,Playback(no_fue_posible_conectar_su_llamada,noanswer)
;exten => sim-PARAM_MISSING,1,Dial(DAHDI/g2/${CDR(dni-interop)},45)
exten => sim-PARAM_MISSING,n,Hangup()
;EN CASO SE RECIBA OTRO CODIGO DE ERROR
exten => _sim-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _sim-.,n,Hangup()

;;;1577 LDN
;;;BIENVENIDA: 1577 INTEROP
;exten => _15770[14-8]XXXXXXX,1,Answer
exten => _15770[14-8]XXXXXXX,1,Playback(1577_americatel,noanswer)
;;;Analisis de Coberturas - AGENT_ZONE
exten => _15770[14-8]XXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ZONE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=ZONE_IO)
exten => _15770[14-8]XXXXXXX,n,GotoIf($["${errorCode}" != "OK"]?sin-${errorCode},1)
exten => _15770[14-8]XXXXXXX,n,Set(DID_EXTEN=1577125${EXTEN:4})
exten => _15770[14-8]XXXXXXX,n,NoOp(DID_EXTEN ${DID_EXTEN})
exten => _15770[14-8]XXXXXXX,n,NoOp(CLI_NUMBER ${CALLERID(num)})
exten => _15770[14-8]XXXXXXX,n,Goto(${DID_EXTEN},1)
;;;ETAPA VALIDACION: 1577 INTEROP
;;;exten => _15770[14-8]XXXXXXX,n(PLANAC),Set(DID_EXTEN=${IF($[${LEN(${did})} = 0]?${EXTEN}:${did})})
;;;exten => _15770[14-8]XXXXXXX,n,NoOp(did_exten ${DID_EXTEN})
exten => _15770[14-8]XXXXXXX,n(PLANAC),NoOp(exten ${EXTEN})
;;;Cambios en la facturacion ENTEL CHILE
exten => _15770[14-8]XXXXXXX,n,Set(cdr-dni-interop=1577${EXTEN:5})
exten => _15770[14-8]XXXXXXX,n,Set(CDR(dni-interop)=${EXTEN})
exten => _15770[14-8]XXXXXXX,n,AGI(agi://192.168.62.31/validacion,agent=Agent_1577,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=AM_IO)
exten => _15770[14-8]XXXXXXX,n,Goto(sin-${errorCode},1)
exten => sin-OK,1,Gosub(procesoInterop,s,1)
;;;PROCESO DE ERRORES
;SI EL ANI TIENE UN PLAN 1577 PERO EL DESTINO MARCADO NO TIENE TARIFA ASIGNADA
;SE RECIBE CODIGO DE ERROR: ZONE_NOT_VALID
exten => sin-ZONE_NOT_VALID,1,Playback(no_esta_permitidoeldestino,noanswer)
exten => sin-ZONE_NOT_VALID,n,Hangup()
;SE RECIBE CODIGO DE ERROR: NO_TARIFF
exten => sin-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => sin-NO_TARIFF,n,Hangup()
;SI EL ANI NO TIENE UN PLAN 1577 SE RECIBE CODIGO DE ERROR: PARAM_MISSING
exten => sin-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado,noanswer)
;exten => sin-PARAM_MISSING,1,Dial(DAHDI/g2/${CDR(dni-interop)},45)
exten => sin-PARAM_MISSING,n,Hangup()
;EN CASO SE RECIBA OTRO CODIGO DE ERROR
exten => _sin-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _sin-.,n,Hangup()

;;;1577 LDI
;;;BIENVENIDA: 1577 INTEROP
;exten => _157700.,1,Answer
exten => _157700.,1,Playback(1577_americatel,noanswer)
;;;Analisis de Coberturas - AGENT_ZONE
exten => _157700.,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ZONE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=ZONE_IO)
exten => _157700.,n,GotoIf($["${errorCode}" != "OK"]?sii-${errorCode},1)
exten => _157700.,n,Set(DID_EXTEN=1577125${EXTEN:4})
exten => _157700.,n,NoOp(DID_EXTEN ${DID_EXTEN})
exten => _157700.,n,NoOp(CLI_NUMBER ${CALLERID(num)})
exten => _157700.,n,Goto(${DID_EXTEN},1)
;;;ETAPA VALIDACION: 1577 INTEROP
exten => _157700.,n(PLANAC),NoOp(exten ${EXTEN})
exten => _157700.,n,Set(CDR(dni-interop)=${EXTEN})
exten => _157700.,n,AGI(agi://192.168.62.31/validacion,agent=Agent_1577,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=${EXTEN},cli=${CALLERID(num)},trunkName=AM_IO)
exten => _157700.,n,Goto(sii-${errorCode},1)
exten => sii-OK,1,Gosub(procesoInterop,s,1)
;;;PROCESO DE ERRORES
;SI EL ANI TIENE UN PLAN 1577 PERO EL DESTINO MARCADO NO TIENE TARIFA ASIGNADA
;SE RECIBE CODIGO DE ERROR: ZONE_NOT_VALID
exten => sii-ZONE_NOT_VALID,1,Playback(no_esta_permitidoeldestino,noanswer)
exten => sii-ZONE_NOT_VALID,n,Hangup()
;SE RECIBE CODIGO DE ERROR: NO_TARIFF
exten => sii-NO_TARIFF,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => sii-NO_TARIFF,n,Hangup()
;SI EL ANI NO TIENE UN PLAN 1577 SE RECIBE CODIGO DE ERROR: PARAM_MISSING
exten => sii-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado,noanswer)
;exten => sii-PARAM_MISSING,1,Dial(DAHDI/g2/${CDR(dni-interop)},45)
exten => sii-PARAM_MISSING,n,Hangup()
;EN CASO SE RECIBA OTRO CODIGO DE ERROR
exten => _sii-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _sii-.,n,Hangup()

;;;############# DID: 1577125 / Servicio 1577 PLAN A (Flexibles) / PLAN C (Control) ################;;;
;;;BIENVENIDA: PLAN A (Flexibles) / PLAN C (CONTROL)
;exten => _1577125.,1,Answer
;exten => _1577125.,n,Playback(bienvenido_al_1577_de_americatel)
exten => _1577125.,1,AGI(agi://192.168.62.31/validacion_bun,agent=Agent_1577,did=${EXTEN},cli=${CALLERID(num)},switchNumber=1,channelNumberIn=${CHANNEL:8},trunkName=AM_IO)
exten => _1577125.,n,Goto(pac-${errorCode},1)
;;;Flujo de Verificacion de BUN
exten => pac-OK,1,Goto(s-VERIFICAR_PLAN,1)
;SI EL ANI NO TIENE UN PLAN 1577 SE RECIBE CODIGO DE ERROR: PARAM_MISSING
exten => pac-PARAM_MISSING,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => pac-PARAM_MISSING,n,Hangup()
exten => _pac-.,1,Playback(este_num_telf_no_esta_registrado,noanswer)
exten => _pac-.,n,Hangup()
;;;Nuevo Flujo IVR 1577
exten => s-VERIFICAR_PLAN,1,Playback(su_saldo_esde)
exten => s-VERIFICAR_PLAN,n,SayNumber(${saldo_soles})
exten => s-VERIFICAR_PLAN,n,Playback(nuevos_soles)
exten => s-VERIFICAR_PLAN,n,Playback(y)
exten => s-VERIFICAR_PLAN,n,SayNumber(${saldo_centimos})
exten => s-VERIFICAR_PLAN,n,Playback(centimos)
exten => s-VERIFICAR_PLAN,n,NoOp(ivr_simple: did ${did})
exten => s-VERIFICAR_PLAN,n,Goto(${did},PLANAC)

;;;ETAPA PROCESO: PLAN CONTROL
[proceso]
exten => s,1,Read(DNI,estimadocliente&porfavor&ingrese_numero_destino,,,2,6)
exten => s,n,GotoIf($["${DNI}" = ""]?s-NO_INGRESO_NUMBER,1)
exten => s-NO_INGRESO_NUMBER,1,Playback(hasta_pronto_gracias_por_preferir&americatelperu)
exten => s-NO_INGRESO_NUMBER,n,Hangup()

;============= Pruebas 1977123 - ANI 14368814 =============;
;exten => s,n,Set(proceso=${IF($[${CALLERID(num)} = 14368814]?proceso\_1977:proceso)})
;===>exten => s,n,Set(proceso=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?proceso\_1977:proceso)})
;===>exten => s,n,NoOp(Marco Risco - proceso: ${proceso} - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName})
;exten => s,n,AGI(agi://192.168.62.31/proceso,agent=AGENT,dni=${DNI})
;;exten => s,n,AGI(agi://192.168.62.31/proceso,agent=AGENT,dni=${DNI},cli=${CALLERID(num)})
;===>exten => s,n,GotoIf($[$[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 52202020]]?portax-central)
;===>exten => s,n,AGI(agi://192.168.62.31/${proceso},agent=${agent},dni=${DNI},cli=${CALLERID(num)})
;===>exten => s,n,Goto(portax-continue)
;===>exten => s,n(portax-central),AGI(agi://192.168.62.31/${proceso},agent=${agent},dni=${DNI},cli=${CALLERID(num)},pre_prod=1)
;exten => s,n,Set(errorCode=${IF($[$[${CALLERID(num)} = 14368814] & $["${errorCode}" = "OK"]]?IVR_OK:OK)})
;===>exten => s,n(portax-continue),Set(errorCode=${IF($[$[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]] & $["${errorCode}" = "OK"]]?IVR_OK:${errorCode})})
;============= Pruebas 1977123 - ANI 14368814 =============;

;=================== Integracion 1977123 ===================;
exten => s,n,NoOp(Integracion 1977123 - proceso: ${proceso} - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName})
exten => s,n,AGI(agi://192.168.62.31/${proceso},agent=${agent},dni=${DNI},cli=${CALLERID(num)})
exten => s,n,Set(errorCode=${IF($[$["${agent}" = "AGENT_1977123"] & $["${errorCode}" = "OK"]]?IVR_OK:${errorCode})})
;=================== Integracion 1977123 ===================;

exten => s,n,Goto(p-${errorCode},1)
exten => p-OK,1,NoOp(${DNI})
exten => p-OK,n,Playback(ud_tiene)

;============= Pruebas 1977123 - ANI 14368814 =============;
;exten => p-OK,n,Set(tiempo_disponible=${IF($[${CALLERID(num)} = 14368814]?${minutos_disponibles}:${samples_disponibles})})
;===>exten => p-OK,n,Set(tiempo_disponible=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?${minutos_disponibles}:${samples_disponibles})})
;;exten => p-OK,n,SayNumber(${samples_disponibles})
;===>exten => p-OK,n,SayNumber(${tiempo_disponible})
;============= Pruebas 1977123 - ANI 14368814 =============;

;=================== Integracion 1977123 ===================;
exten => p-OK,n,Set(tiempo_disponible=${IF($[$["${agent}" = "AGENT_1977123"]]?${minutos_disponibles}:${samples_disponibles})})
exten => p-OK,n,SayNumber(${tiempo_disponible})
;=================== Integracion 1977123 ===================;

exten => p-OK,n,Playback(minutos_disponible_para_estallamada)
exten => p-OK,n,Gosub(billing,s,1)
exten => p-PARAM_MISSING,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => p-PARAM_MISSING,n,Hangup()
exten => p-NOT_FOUND,1,Playback(serv_no_habilitado_para_este_destino)
exten => p-NOT_FOUND,n,Hangup()
exten => p-NO_TARIFF,1,Playback(no_esta_permitidoeldestino)
exten => p-NO_TARIFF,n,Hangup()
exten => p-NO_SALDO_AVAILABLE,1,Playback(no_cuenta_con_saldo_suficiente_para_llamadas)
exten => p-NO_SALDO_AVAILABLE,n,Hangup()
exten => p-NUMERO_NO_VALIDO,1,Playback(elnum_ingresado_es_incorrecto)
exten => p-NUMERO_NO_VALIDO,n,Hangup()
exten => p-IVR_SERVICE,1,Goto(s,1)
;exten => h,1,NoOp('FORCED HANGUP en fase de PROCESO')
;exten => h,n,Gosub(billing-forced,s,1)
;=================== Integracion 1977123 ===================;
;===>;============= Pruebas 1977123 - ANI 14368814 =============;
exten => p-IVR_OK,1,NoOp(${DNI})
exten => p-IVR_OK,n,AGI(agi://192.168.62.31/validacion,agent=AGENT_ZONE,switchNumber=1,channelNumberIn=${CHANNEL:8},channelIn=${CHANNEL},did=1977${DNI},cli=${CALLERID(num)},trunkName=ZONE_IO)
exten => p-IVR_OK,n,GotoIf($["${errorCode}" = "OK"]?ZoneOK)
exten => p-IVR_OK,n,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => p-IVR_OK,n,Hangup()
exten => p-IVR_OK,n(ZoneOK),NoOp(Cobertura errorCode - ${errorCode})
exten => p-IVR_OK,n,Playback(su_saldo_es_de)
exten => p-IVR_OK,n,SayNumber(${saldo_soles})
exten => p-IVR_OK,n,Playback(nuevos_soles)
exten => p-IVR_OK,n,Playback(y)
exten => p-IVR_OK,n,SayNumber(${saldo_centimos})
exten => p-IVR_OK,n,Playback(centimos)
exten => p-IVR_OK,n,Read(numero_minutos,ingrese-numero-minutos,,,,6)
exten => p-IVR_OK,n,NoOp(numero_minutos ${numero_minutos})
exten => p-IVR_OK,n,GotoIf($["${LEN(${numero_minutos})}" = "0"]?NoMinutos)
exten => p-IVR_OK,n,NoOp(numero_minutos ${numero_minutos} -- minutos_disponibles ${minutos_disponibles})
exten => p-IVR_OK,n,GotoIf($[${numero_minutos} < ${minutos_disponibles}]?NoMinutos)
exten => p-IVR_OK,n,Read(numero_minutos,saldo-no-permite-llamada,,,,4)
exten => p-IVR_OK,n,GotoIf($["${LEN(${numero_minutos})}" = "0"]?NoMinutos)
exten => p-IVR_OK,n,NoOp(numero_minutos ${numero_minutos} -- minutos_disponibles ${minutos_disponibles})
exten => p-IVR_OK,n,GotoIf($[${numero_minutos} < ${minutos_disponibles}]?NoMinutos)
exten => p-IVR_OK,n,Playback(lo_siento_pero)
exten => p-IVR_OK,n,Playback(saldo_insuficiente_para_llamada)
exten => p-IVR_OK,n,Playback(hasta_pronto_gracias_por_preferir&americatelperu)
exten => p-IVR_OK,n,Hangup()
exten => p-IVR_OK,n(NoMinutos),NoOp(did ${DNI} - numero_minutos ${numero_minutos})
exten => p-IVR_OK,n,Gosub(billing,s,1)
;===>;============= Pruebas 1977123 - ANI 14368814 =============;
;=================== Integracion 1977123 ===================;

;;;ETAPA BILLING: PLAN CONTROL
[billing]
;=================== Integracion 1977123 ===================;
exten => s,1,NoOp(Integracion 1977123 - billing - numero_minutos ${numero_minutos})
exten => s,n,Set(timeout_sec=${IF($["${LEN(${numero_minutos})}" = "0"]?$[${samples_disponibles}*${sampDelayInSec}]:$[${numero_minutos}*60])})
exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(did-cdr=${IF($[$["${agent}" = "AGENT_1977123"]]?${dni_salida}:${dni_canonical})})
exten => s,n,Set(familyName=${IF($[$["${agent}" = "AGENT_1977123"]]?P1977:FAM)})
exten => s,n,Set(billing=${IF($[$["${agent}" = "AGENT_1977123"]]?BILLING_1977123:BILLING)})
exten => s,n,Set(CDR(familyName)=${familyName})
exten => s,n,NoOp(Integracion 1977123 - dial - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName} - familyName : ${CDR(familyName)} - billing : ${billing} - did-cdr: ${did-cdr} - dni_canonical ${dni_canonical})
exten => s,n,Dial(DAHDI/g1/${dni_salida},45,S(${timeout_sec}))
;=================== Integracion 1977123 ===================;

;============= Pruebas 1977123 - ANI 14368814 =============;
;===>exten => s,1,NoOp(BILLING ==========> numero_minutos ${numero_minutos})
;===>exten => s,n,Set(timeout_sec=${IF($["${LEN(${numero_minutos})}" = "0"]?$[${samples_disponibles}*${sampDelayInSec}]:$[${numero_minutos}*60])})
;;exten => s,1,Set(TIMEOUT(absolute)=$[${samples_disponibles}*${sampDelayInSec}])
;============= Pruebas 1977123 - ANI 14368814 =============;
;===>exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
;============= Pruebas 1977123 - ANI 14368814 =============;
;exten => s,n,Set(did-cdr=${IF($[${CALLERID(num)} = 14368814]?${dni_salida}:${dni_canonical})})
;===>exten => s,n,Set(did-cdr=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?${dni_salida}:${dni_canonical})})
;exten => s,n,Set(familyName=${IF($[${CALLERID(num)} = 14368814]?P1977:FAM)})
;===>exten => s,n,Set(familyName=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?P1977:FAM)})
;exten => s,n,Set(billing=${IF($[${CALLERID(num)} = 14368814]?BILLING\_1977123:BILLING)})
;===>exten => s,n,Set(billing=${IF($[$[${CALLERID(num)} = 14368814] | $[${CALLERID(num)} = 14960475] | $[${CALLERID(num)} = 15604456] | $[${CALLERID(num)} = 14622496] | $[${CALLERID(num)} =  17198928] | $[${CALLERID(num)} = 17192841] | $[${CALLERID(num)} = 14792493] | $[${CALLERID(num)} = 17130302] | $[${CALLERID(num)} = 17130305]]?BILLING\_1977123:BILLING)})
;;exten => s,n,Set(CDR(familyName)=FAM)
;===>exten => s,n,Set(CDR(familyName)=${familyName})
;===>exten => s,n,NoOp(Marco Risco - dial - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName} - familyName : ${CDR(familyName)} - billing : ${billing} - did-cdr: ${did-cdr} - dni_canonical ${dni_canonical})
;;exten => s,n,Dial(DAHDI/g1/${dni_salida},45)
;===>exten => s,n,Dial(DAHDI/g1/${dni_salida},45,S(${timeout_sec}))
;============= Pruebas 1977123 - ANI 14368814 =============;

exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-ANSWER,1,Playback(AmerTel)
exten => s-ANSWER,n,Hangup()
exten => s-NOANSWER,1,Playback(el_num_que_marco_no_contesta)
exten => s-NOANSWER,n,Hangup()
exten => s-CHANUNAVAIL,1,Playback(no_fue_posible_conectar_su_llamada)
exten => s-CHANUNAVAIL,n,Hangup()
exten => s-CONGESTION,1,Playback(no_fue_posible_conectar_su_llamada)
exten => s-CONGESTION,n,Hangup()
exten => s-BUSY,1,Playback(el_num_que_marco_esta_ocupado)
exten => s-BUSY,n,Hangup()
exten => h,1,NoOp(${CDR(duration-callin)})

;=================== Integracion 1977123 ===================;
;===>;============= Pruebas 1977123 - ANI 14368814 =============;
exten => h,n,NoOp(Integracion 1977123 - billing - cli : ${CALLERID(num)} - agent : ${agent} - trunkName : ${trunkName} - familyName : ${CDR(familyName)} - billing : ${billing} - did-cdr: ${did-cdr})
;;exten => h,n,AGI(agi://192.168.62.31/billing,agent=AGENT,did=1977124,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})
exten => h,n,AGI(agi://192.168.62.31/billing,agent=${agent},did=1977124,did-cdr=${did-cdr},switchNumber=1,cli=${CALLERID(num)},trunkName=${trunkName},billing=${billing},family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})
;===>;============= Pruebas 1977123 - ANI 14368814 =============;
;=================== Integracion 1977123 ===================;

[billing-forced]
exten => s,1,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,NoOp(${CDR(duration-callin)})
exten => s,n,AGI(agi://192.168.62.31/billing,agent=AGENT,did=1977124,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=FORCED,releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

;;;ETAPA PROCESO: PLAN BONOS
[procesoBonos]
;exten => s,1,Read(DNI,estimadocliente&porfavor&ingrese_numero_destino,,,2,4)
exten => s,1,Read(DNI,estimadocliente&porfavor&ingrese_el_num_al_cual_desea_llamar,,,2,4)
exten => s,n,GotoIf($["${DNI}" = ""]?s-NO_INGRESO_NUMBER,1)
exten => s-NO_INGRESO_NUMBER,1,Playback(hasta_pronto_gracias_por_preferir&americatelperu)
exten => s-NO_INGRESO_NUMBER,n,Hangup()
exten => s,n,GotoIf($[$[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 52202020]]?portax-central)
exten => s,n,AGI(agi://192.168.62.31/proceso,agent=AGENT_BONOS,dni=${DNI})
exten => s,n,Goto(portax-continue)
exten => s,n(portax-central),AGI(agi://192.168.62.31/proceso,agent=AGENT_BONOS,dni=${DNI},pre_prod=1)
exten => s,n(portax-continue),Goto(pb-${errorCode},1)
exten => pb-OK,1,NoOp(${DNI})
exten => pb-OK,n,Playback(ud_tiene)
exten => pb-OK,n,SayNumber(${samples_disponibles})
exten => pb-OK,n,Playback(minutos_disponible_para_estallamada)
exten => pb-OK,n,Gosub(billingBonos,s,1)
exten => pb-PARAM_MISSING,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => pb-PARAM_MISSING,n,Hangup()
exten => pb-NOT_FOUND,1,Playback(serv_no_habilitado_para_este_destino)
exten => pb-NOT_FOUND,n,Hangup()
exten => pb-NO_TARIFF,1,Playback(no_esta_permitidoeldestino)
exten => pb-NO_TARIFF,n,Hangup()
exten => pb-NO_SALDO_AVAILABLE,1,Playback(no_cuenta_con_saldo_suficiente_para_llamadas)
exten => pb-NO_SALDO_AVAILABLE,n,Hangup()
exten => pb-IVR_SERVICE,1,Goto(s,1)
exten => h,1,NoOp('FORCED HANGUP en fase de PROCESO')
exten => h,n,Gosub(billing-bonos-forced,s,1)

;;;ETAPA BILLING: PLAN BONOS
[billingBonos]
exten => s,1,Set(TIMEOUT(absolute)=$[${samples_disponibles}*${sampDelayInSec}])
exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(CDR(familyName)=BONOS)
exten => s,n,Dial(DAHDI/g1/${dni_salida},45)
exten => s,n,Goto(sb-${DIALSTATUS},1)
exten => sb-ANSWER,1,Playback(AmerTel)
exten => sb-ANSWER,n,Hangup()
exten => sb-NOANSWER,1,Playback(el_num_que_marco_no_contesta)
exten => sb-NOANSWER,n,Hangup()
exten => sb-CHANUNAVAIL,1,Playback(no_fue_posible_conectar_su_llamada)
exten => sb-CHANUNAVAIL,n,Hangup()
exten => sb-CONGESTION,1,Playback(no_fue_posible_conectar_su_llamada)
exten => sb-CONGESTION,n,Hangup()
exten => sb-BUSY,1,Playback(el_num_que_marco_esta_ocupado)
exten => sb-BUSY,n,Hangup()
exten => h,1,NoOp(${CDR(duration-callin)})
exten => h,n,AGI(agi://192.168.62.31/billing,agent=AGENT_BONOS,did=1977144,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING_BONOS,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

[billing-bonos-forced]
exten => s,1,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(CDR(familyName)=BONOS)
exten => s,n,NoOp(${CDR(duration-callin)})
exten => s,n,AGI(agi://192.168.62.31/billing,agent=AGENT_BONOS,did=1977144,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=BILLING_BONOS,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=FORCED,releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

;;;ETAPA PROCESO: PREPAGO
[procesoPrepaid]
;exten => s,1,Read(DNI,estimadocliente&porfavor&ingrese_el_num_al_cual_desea_llamar,,,2,5)
exten => s,1,Read(DNI,estimadocliente&porfavor&ingrese_numero_destino,,,2,4)
exten => s,n,GotoIf($["${DNI}" = ""]?s-NO_INGRESO_NUMBER,1)
exten => s-NO_INGRESO_NUMBER,1,Playback(hasta_pronto_gracias_por_preferir&americatelperu)
exten => s-NO_INGRESO_NUMBER,n,Hangup()
exten => s,n,GotoIf($[$[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 52202020]]?portax-central)
exten => s,n,AGI(agi://192.168.62.31/proceso_1566,agent=Agent_Prepaid,dni=${DNI})
exten => s,n,Goto(portax-continue)
exten => s,n(portax-central),AGI(agi://192.168.62.31/proceso_1566,agent=Agent_Prepaid,dni=${DNI},pre_prod=1)
exten => s,n(portax-continue),Goto(pp-${errorCode},1)
exten => pp-OK,1,NoOp(${DNI})
exten => pp-OK,n,Playback(ud_tiene)
exten => pp-OK,n,SayNumber(${samples_disponibles})
exten => pp-OK,n,Playback(minutos_disponible_para_estallamada)
exten => pp-OK,n,Gosub(billingPrepaid,s,1)
exten => pp-PARAM_MISSING,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => pp-PARAM_MISSING,n,Hangup()
exten => pp-NOT_FOUND,1,Playback(serv_no_habilitado_para_este_destino)
exten => pp-NOT_FOUND,n,Hangup()
exten => pp-NO_TARIFF,1,Playback(no_esta_permitidoeldestino)
exten => pp-NO_TARIFF,n,Hangup()
exten => pp-NO_SALDO_AVAILABLE,1,Playback(saldo_insuficiente_para_llamada)
exten => pp-NO_SALDO_AVAILABLE,n,Hangup()
exten => pp-IVR_SERVICE,1,Goto(s,1)
exten => h,1,NoOp('FORCED HANGUP en fase de PROCESO')
exten => h,n,Gosub(billing-prepaid-forced,s,1)

;;;ETAPA BILLING: PREPAGO
[billingPrepaid]
exten => s,1,Set(TIMEOUT(absolute)=$[${samples_disponibles}*${sampDelayInSec}])
exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(CDR(familyName)=PREPA)
exten => s,n,Dial(DAHDI/g1/${dni_salida},45)
exten => s,n,Goto(bp-${DIALSTATUS},1)
exten => bp-ANSWER,1,Playback(AmerTel)
exten => bp-ANSWER,n,Hangup()
exten => bp-NOANSWER,1,Playback(el_num_que_marco_no_contesta)
exten => bp-NOANSWER,n,Hangup()
exten => bp-CHANUNAVAIL,1,Playback(no_fue_posible_conectar_su_llamada)
exten => bp-CHANUNAVAIL,n,Hangup()
exten => bp-CONGESTION,1,Playback(no_fue_posible_conectar_su_llamada)
exten => bp-CONGESTION,n,Hangup()
exten => bp-BUSY,1,Playback(el_num_que_marco_esta_ocupado)
exten => bp-BUSY,n,Hangup()
exten => h,1,NoOp(${CDR(duration-callin)})
exten => h,n,AGI(agi://192.168.62.31/billing,agent=Agent_Prepaid,did=1566,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=Billing_Prepaid,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

[billing-prepaid-forced]
exten => s,1,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,NoOp(${CDR(duration-callin)})
exten => s,n,Set(CDR(familyName)=PREPA)
exten => s,n,AGI(agi://192.168.62.31/billing,agent=Agent_Prepaid,did=1566,did-cdr=${dni_canonical},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=Billing_Prepaid,family=${CDR(familyName)},inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=FORCED,releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

;;;ETAPA PROCESO: 1577 INTEROP
[procesoInterop]
exten => s,1,NoOp(${CDR(dni-interop)} - numero_minutos ${numero_minutos})
exten => s,n,GotoIf($[$[${CALLERID(num)} = 17198928] | $[${CALLERID(num)} = 52202020]]?portax-central)
exten => s,n,AGI(agi://192.168.62.31/proceso_1577,agent=Agent_1577,cli=${CALLERID(num)},dni=${CDR(dni-interop)})
exten => s,n,Goto(portax-continue)
exten => s,n(portax-central),AGI(agi://192.168.62.31/proceso_1577,agent=Agent_1577,cli=${CALLERID(num)},dni=${CDR(dni-interop)},pre_prod=1)
exten => s,n(portax-continue),Goto(pi-${errorCode},1)
exten => pi-OK,1,NoOp(${errorCode})
exten => pi-OK,n,Set(minutos_disponibles=${IF($["${LEN(${numero_minutos})}" = "0"]?${minutos_disponibles}:${numero_minutos})})
exten => pi-OK,n,Playback(ud_tiene)
;;;exten => pi-OK,n,SayNumber(${samples_disponibles})
exten => pi-OK,n,SayNumber(${minutos_disponibles})
exten => pi-OK,n,Playback(minutos_disponible_para_estallamada)
exten => pi-OK,n,Gosub(billingInterop,s,1)
exten => pi-PARAM_MISSING,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => pi-PARAM_MISSING,n,Hangup()
exten => pi-NOT_FOUND,1,Playback(serv_no_habilitado_para_este_destino)
exten => pi-NOT_FOUND,n,Hangup()
exten => pi-NO_TARIFF,1,Playback(no_esta_permitidoeldestino)
exten => pi-NO_TARIFF,n,Hangup()
exten => pi-NO_SALDO_AVAILABLE,1,Playback(lo_siento_no_fue_posible_conectar_su_llamada)
exten => pi-NO_SALDO_AVAILABLE,n,Hangup()

;;;ETAPA BILLING: 1577 INTEROP
[billingInterop]
exten => s,1,NoOp(numero_minutos ${numero_minutos})
exten => s,n,NoOp(samples_disponibles ${samples_disponibles} - sampDelayInSec ${sampDelayInSec})
exten => s,n,Set(timeout_sec=${IF($["${LEN(${numero_minutos})}" = "0"]?$[${samples_disponibles}*${sampDelayInSec}]:$[${numero_minutos}*60])})
;exten => s,n,Set(timeout_sec=10)
;exten => s,n,Set(TIMEOUT(absolute)=${timeout_sec})
;exten => s,n,Set(TIMEOUT(absolute)=15)
exten => s,n,Set(CDR(duration-callin)=${CDR(billsec)})
exten => s,n,Set(CDR(familyName)=1577)
exten => s,n,Dial(DAHDI/g1/${dni_salida},45,S(${timeout_sec}))
;exten => s,n,Dial(DAHDI/g2/${dni_salida},45)
;exten => s,n,Dial(SIP/rip-synway/${dni_salida},45)
exten => s,n,Goto(bi-${DIALSTATUS},1)
exten => bi-ANSWER,1,NoOp(${DIALSTATUS})
exten => bi-ANSWER,n,Hangup()
exten => bi-NOANSWER,1,Playback(el_num_que_marco_no_contesta)
exten => bi-NOANSWER,n,Hangup()
exten => bi-CHANUNAVAIL,1,Playback(no_fue_posible_conectar_su_llamada)
exten => bi-CHANUNAVAIL,n,Hangup()
exten => bi-CONGESTION,1,Playback(no_fue_posible_conectar_su_llamada)
exten => bi-CONGESTION,n,Hangup()
exten => bi-BUSY,1,Playback(el_num_que_marco_esta_ocupado)
exten => bi-BUSY,n,Hangup()
exten => h,1,NoOp(${CDR(duration-callin)})
exten => h,n,Set(CDR(dni-interop)=${IF($["${LEN(${cdr-dni-interop})}" = "0"]?$[${CDR(dni-interop)}]:$[${cdr-dni-interop}])})
exten => h,n,NoOp(did ${CDR(dni-interop)} - cli ${CALLERID(num)} - cdr-dni-interop ${cdr-dni-interop})
exten => h,n,AGI(agi://192.168.62.31/billing,agent=Agent_1577,did=${CDR(dni-interop)},did-cdr=${CDR(dni-interop)},switchNumber=1,cli=${CALLERID(num)},trunkName=AM_IO,billing=Billing_1577,inicio=${CDR(start)},duracion=${CDR(duration)},billsec=${CDR(billsec)},answer=${CDR(answer)},duration-callin=${CDR(duration-callin)},telecomResult=${DIALSTATUS},releaseCause=${HANGUPCAUSE},channelNumberOut=${CHANNEL:8},channelOut=${CHANNEL},callID=${UNIQUEID})

